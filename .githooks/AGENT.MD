---
description: "Contexto .githooks - Git Hooks Personalizados"
agent: "Git_Hooks"
capabilities: ["pre_commit_validation", "code_quality_enforcement", "automated_testing"]
triggers: ["git_commit", "git_push", "code_changes"]
---

# .GITHOOKS - CONTEXTO DE CARPETA

## DESCRIPCI√ìN GENERAL
Esta carpeta contiene hooks de Git personalizados para TRAE-CLI. Implementa validaci√≥n autom√°tica de c√≥digo, testing y cumplimiento de est√°ndares antes de commits y pushes.

## ARQUITECTURA DE GIT HOOKS

### Tipos de Hooks Implementados

#### Pre-commit Hook
- **Validaci√≥n de C√≥digo**: Ejecuta `cargo check` y `cargo clippy`
- **Formateo**: Asegura que `cargo fmt` ha sido ejecutado
- **Tests**: Corre tests unitarios b√°sicos
- **Zero Warnings**: Falla si hay warnings de compilaci√≥n

#### Pre-push Hook
- **Tests Completos**: Ejecuta `cargo test --all-targets`
- **Integration Tests**: Corre tests de integraci√≥n si existen
- **Benchmark Checks**: Verifica que benchmarks compilen
- **Documentation**: Valida que docs se generen correctamente

#### Commit-msg Hook
- **Formato de Mensajes**: Valida formato de commit messages
- **Issue References**: Verifica referencias a issues
- **Conventional Commits**: Enforce conventional commit format

### Estructura de Hooks
```
.githooks/
‚îú‚îÄ‚îÄ pre-commit          # Validaci√≥n antes de commit
‚îú‚îÄ‚îÄ pre-push           # Validaci√≥n antes de push
‚îú‚îÄ‚îÄ commit-msg         # Validaci√≥n de mensaje de commit
‚îú‚îÄ‚îÄ post-commit        # Acciones post-commit
‚îú‚îÄ‚îÄ post-merge         # Acciones post-merge
‚îî‚îÄ‚îÄ prepare-commit-msg # Preparaci√≥n de mensaje de commit
```

## PRE-COMMIT HOOK

### Implementaci√≥n Principal
```bash
#!/bin/bash
# .githooks/pre-commit

set -e  # Exit on any error

echo "üöÄ Running TRAE-CLI pre-commit hooks..."

# 1. Check if cargo is available
if ! command -v cargo &> /dev/null; then
    echo "‚ùå Cargo not found. Please install Rust."
    exit 1
fi

# 2. Run cargo check (fast compilation check)
echo "üîç Running cargo check..."
if ! cargo check --quiet; then
    echo "‚ùå Cargo check failed. Please fix compilation errors."
    echo "üí° Run 'cargo check' to see detailed errors."
    exit 1
fi

# 3. Run cargo clippy (linting)
echo "üîß Running cargo clippy..."
if ! cargo clippy --quiet -- -D warnings; then
    echo "‚ùå Clippy found warnings. Please fix them."
    echo "üí° Run 'cargo clippy' to see detailed warnings."
    exit 1
fi

# 4. Check formatting
echo "üìù Checking code formatting..."
if ! cargo fmt --check; then
    echo "‚ùå Code is not properly formatted."
    echo "üí° Run 'cargo fmt' to format your code."
    exit 1
fi

# 5. Run basic tests
echo "üß™ Running unit tests..."
if ! cargo test --quiet --lib; then
    echo "‚ùå Unit tests failed. Please fix them."
    echo "üí° Run 'cargo test' to see failing tests."
    exit 1
fi

echo "‚úÖ All pre-commit checks passed!"
exit 0
```

### Configuraci√≥n de Clippy
```bash
# Configuraci√≥n adicional para clippy en pre-commit
export RUSTFLAGS="-D warnings"
cargo clippy -- \
    -D clippy::all \
    -D clippy::pedantic \
    -D clippy::nursery \
    --deny warnings
```

## PRE-PUSH HOOK

### Validaciones Avanzadas
```bash
#!/bin/bash
# .githooks/pre-push

set -e

echo "üöÄ Running TRAE-CLI pre-push validation..."

# 1. Run full test suite
echo "üß™ Running full test suite..."
if ! cargo test --all-targets --quiet; then
    echo "‚ùå Full test suite failed."
    echo "üí° Run 'cargo test --all-targets' to debug."
    exit 1
fi

# 2. Check documentation
echo "üìö Checking documentation..."
if ! cargo doc --no-deps --quiet; then
    echo "‚ùå Documentation generation failed."
    echo "üí° Run 'cargo doc' to see issues."
    exit 1
fi

# 3. Run benchmarks (if they exist)
if cargo bench --help &> /dev/null; then
    echo "‚ö° Running benchmarks..."
    if ! cargo bench --quiet; then
        echo "‚ùå Benchmarks failed."
        echo "üí° Run 'cargo bench' to debug."
        exit 1
    fi
fi

# 4. Check for security issues
if command -v cargo-audit &> /dev/null; then
    echo "üîí Running security audit..."
    if ! cargo audit --quiet; then
        echo "‚ùå Security audit found issues."
        echo "üí° Run 'cargo audit' to see vulnerabilities."
        exit 1
    fi
fi

# 5. Validate CI configuration
echo "üîÑ Validating CI configuration..."
if [ -f ".github/workflows/ci.yml" ]; then
    if ! yamllint .github/workflows/ci.yml; then
        echo "‚ùå CI configuration has YAML issues."
        exit 1
    fi
fi

echo "‚úÖ All pre-push validations passed!"
exit 0
```

## COMMIT-MSG HOOK

### Validaci√≥n de Mensajes
```bash
#!/bin/bash
# .githooks/commit-msg

set -e

COMMIT_MSG_FILE="$1"
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

echo "üìù Validating commit message..."

# 1. Check minimum length
if [ ${#COMMIT_MSG} -lt 10 ]; then
    echo "‚ùå Commit message too short (minimum 10 characters)."
    exit 1
fi

# 2. Check conventional commit format
if ! echo "$COMMIT_MSG" | grep -qE "^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?: .{10,}"; then
    echo "‚ùå Commit message doesn't follow conventional commit format."
    echo "üí° Use: type(scope): description"
    echo "     Types: feat, fix, docs, style, refactor, test, chore"
    exit 1
fi

# 3. Check for issue references
if ! echo "$COMMIT_MSG" | grep -qE "#[0-9]+|closes #[0-9]+|fixes #[0-9]+"; then
    echo "‚ö†Ô∏è  Consider referencing an issue (e.g., #123, closes #123)."
fi

echo "‚úÖ Commit message validation passed!"
exit 0
```

## POST-COMMIT HOOK

### Acciones Autom√°ticas
```bash
#!/bin/bash
# .githooks/post-commit

echo "üìä Running post-commit actions..."

# 1. Update changelog if needed
if [ -f "CHANGELOG.md" ]; then
    echo "üìù Updating changelog..."
    # Logic to update changelog based on commit
fi

# 2. Run light tests to ensure everything still works
echo "üîç Running quick health check..."
cargo check --quiet

# 3. Update any generated files
echo "üîÑ Updating generated files..."
cargo run --bin generate-docs 2>/dev/null || true

echo "‚úÖ Post-commit actions completed!"
```

## CONFIGURACI√ìN E INSTALACI√ìN

### Instalaci√≥n Autom√°tica
```bash
#!/bin/bash
# scripts/install-hooks.sh

echo "üîß Installing TRAE-CLI git hooks..."

# Set git hooks path
git config core.hooksPath .githooks

# Make hooks executable
chmod +x .githooks/*

echo "‚úÖ Git hooks installed successfully!"
echo "üí° Hooks will run automatically on commit/push."
```

### Configuraci√≥n Global
```bash
# .githooks/config - Configuraci√≥n de hooks
[hooks]
    enable_pre_commit = true
    enable_pre_push = true
    enable_commit_msg = true
    strict_mode = true
    allow_warnings = false
```

## INTEGRACI√ìN CON TRAE-CLI

### Comandos TRAE-CLI
```bash
# Verificar hooks
trae hooks --status

# Instalar hooks
trae hooks --install

# Ejecutar validaciones manualmente
trae validate --pre-commit
trae validate --pre-push
```

### Configuraci√≥n TRAE-CLI
```toml
# Cargo.toml - Configuraci√≥n de hooks
[package.metadata.trae.hooks]
pre_commit = ["cargo check", "cargo clippy", "cargo fmt --check", "cargo test"]
pre_push = ["cargo test --all-targets", "cargo audit", "cargo doc"]
commit_msg = ["conventional-commits"]
```

## TESTING DE HOOKS

### Tests Unitarios
```rust
// tests/hooks_test.rs
#[test]
fn test_pre_commit_hook() {
    // Setup test repository
    let temp_dir = TempDir::new().unwrap();
    let repo = Repository::init(temp_dir.path()).unwrap();

    // Configure hooks
    std::fs::create_dir_all(temp_dir.path().join(".githooks")).unwrap();
    std::fs::copy("pre-commit", temp_dir.path().join(".githooks/pre-commit")).unwrap();

    // Make test commit
    std::fs::write(temp_dir.path().join("test.rs"), "fn main() {}").unwrap();
    repo.index().unwrap().add_path(Path::new("test.rs")).unwrap();

    // Test hook execution
    let output = Command::new("git")
        .args(&["commit", "-m", "test commit"])
        .current_dir(temp_dir.path())
        .output()
        .unwrap();

    assert!(output.status.success());
}
```

## MANEJO DE ERRORES

### Recuperaci√≥n de Hooks
```bash
# Saltar hooks temporalmente
git commit --no-verify -m "fix: urgent fix"

# Ejecutar hooks manualmente
./.githooks/pre-commit
./.githooks/pre-push
```

### Debugging de Hooks
```bash
# Ejecutar con debug
GIT_TRACE=1 git commit -m "test"

# Ver logs detallados
export TRAE_HOOKS_DEBUG=1
git commit -m "test"
```

## CONTEXTO DE DESARROLLO

Los git hooks garantizan la calidad del c√≥digo en TRAE-CLI. Implementan el principio "Zero Warnings" y "No Mocks" al nivel de control de versiones, previniendo commits problem√°ticos.

### Puntos de Contacto
- **Git Workflow**: Se ejecutan autom√°ticamente en operaciones git
- **CI/CD**: Complementan las validaciones de GitHub Actions
- **TRAE-CLI**: Integran con comandos de an√°lisis y validaci√≥n

### Mejores Pr√°cticas
- Mantener hooks ligeros para no ralentizar desarrollo
- Proporcionar mensajes de error claros y accionables
- Permitir bypass con --no-verify para casos de emergencia
- Documentar qu√© valida cada hook
- Actualizar hooks cuando cambien est√°ndares del proyecto
